<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Live Vehicle Platform â€” Professional Dashboard</title>

  <style>
    :root{
      --bg:#f4f6f9;
      --card:#ffffff;
      --accent:#0b72d6;
      --accent-2:#0f9d58;
      --muted:#6b7280;
      --danger:#ef4444;
      --radius:14px;
      --shadow: 0 8px 24px rgba(16,24,40,0.06);
      font-family: Inter, "Segoe UI", Roboto, Arial, sans-serif;
      color-scheme: light;
    }
    *{box-sizing:border-box}
    body{background:var(--bg); margin:0; color:#111; -webkit-font-smoothing:antialiased}
    a{color:inherit}
    header{
      background:linear-gradient(90deg,#ffffff,#eef4ff);
      padding:18px 28px;
      box-shadow: 0 2px 8px rgba(16,24,40,0.04);
      display:flex;
      align-items:center;
      gap:16px;
      position:sticky; top:0; z-index:60;
    }
    header .logo{
      width:48px; height:48px; display:inline-grid; place-items:center;
      border-radius:10px; background:linear-gradient(180deg,#ffdede,#fff);
      box-shadow:0 4px 12px rgba(0,0,0,0.04);
    }
    header h1{margin:0; font-size:20px}
    header .subtitle{color:var(--muted); font-size:13px}

    .wrap{max-width:1200px; margin:22px auto; padding:0 16px}
    .topbar{display:flex; justify-content:space-between; gap:12px; align-items:center; margin-bottom:18px}
    .controls{display:flex; gap:12px; align-items:center; flex-wrap:wrap}
    .select, .btn, .smallbtn {
      padding:9px 12px; border-radius:10px; border:1px solid #e6e9ee; background:#fff; font-size:14px;
    }
    .btn{cursor:pointer; background:var(--accent); color:#fff; border:none}
    .smallbtn{background:#fff; color:var(--accent); border:1px solid var(--accent); cursor:pointer}
    .muted{color:var(--muted)}
    .card{background:var(--card); border-radius:var(--radius); padding:18px; box-shadow:var(--shadow); margin-bottom:18px}

    .grid{display:grid; grid-template-columns: 1fr 360px; gap:18px}
    .fullwidth{grid-column: 1 / -1}

    .kv{display:flex; gap:12px; margin:8px 0; align-items:baseline}
    .kv b{width:150px; color:#111}

    table{width:100%; border-collapse: collapse; font-size:14px}
    th, td{padding:10px 12px; border-bottom:1px solid #eef2f7; text-align:left; vertical-align:middle}
    th{background:#f7fbff; color:var(--accent); font-weight:600; position:sticky; top:0}
    tbody tr:hover{background:#fbfdff}
    .table-wrap{overflow:auto; max-height:420px; border-radius:10px; border:1px solid #eef2f7}

    .badge{padding:6px 10px; border-radius:999px; font-weight:600; font-size:13px}
    .ok{background:#ecfdf5; color: #15803d; border:1px solid rgba(21,128,61,0.08)}
    .err{background:#fff1f2; color: #be123c}

    .small{font-size:12px; color:var(--muted)}
    .tiny{font-size:11px; color:var(--muted)}

    @media (max-width:1060px){
      .grid{grid-template-columns: 1fr}
    }
    @media (max-width:480px){
      .kv b{width:110px}
    }
  </style>
</head>
<body>
  <header>
    <div class="logo">ðŸš—</div>
    <div>
      <h1>Live Vehicle Platform</h1>
      <div class="subtitle">Real-time fleet telemetry â€” speeds, temps, history</div>
    </div>

    <div style="margin-left:auto; display:flex; gap:8px; align-items:center">
      <div class="small">Auto refresh</div>
      <select id="refreshInterval" class="select" style="width:110px;">
        <option value="3000">3s</option>
        <option value="5000" selected>5s</option>
        <option value="10000">10s</option>
        <option value="30000">30s</option>
      </select>
    </div>
  </header>

  <div class="wrap">
    <div class="topbar">
      <div class="controls">
        <select id="deviceSelect" class="select">
          <option value="__all">All devices (live)</option>
        </select>

        <button id="refreshNow" class="smallbtn">Refresh now</button>

        <div class="small" style="margin-left:8px">Showing last <span id="rowsCount">â€”</span> records</div>
      </div>

      <div style="display:flex; gap:12px; align-items:center">
        <div class="small">Status:</div>
        <div id="statusBadge" class="badge tiny" style="background:#fff3cd; color:#b45309">Loadingâ€¦</div>
      </div>
    </div>

    <div class="grid">
      <div>
        <div class="card">
          <h2>Latest Device Data</h2>
          <div class="kv"><b>Device ID</b><div id="latest_id">--</div></div>
          <div class="kv"><b>Person Name</b><div id="latest_person">--</div></div>
          <div class="kv"><b>Location</b><div id="latest_location">--</div></div>
          <div class="kv"><b>GPS</b><div id="latest_gps">--</div></div>
          <div class="kv"><b>Speed</b><div id="latest_speed">--</div><span class="muted">km/h</span></div>
          <div class="kv"><b>Engine Temp</b><div id="latest_temp">--</div><span class="muted">Â°C</span></div>
          <div class="kv"><b>Status</b><div id="latest_status">--</div></div>
          <div class="kv"><b>Timestamp</b><div id="latest_ts">--</div></div>
        </div>

        <div class="card">
          <h3>All Vehicle History (latest first)</h3>
          <div class="table-wrap">
            <table>
              <thead>
                <tr>
                  <th>ID</th><th>Person</th><th>Location</th><th>Speed</th><th>Engine Temp</th><th>Status</th><th>GPS</th><th>Timestamp</th>
                </tr>
              </thead>
              <tbody id="historyBody">
                <tr><td colspan="8" class="tiny">Loadingâ€¦</td></tr>
              </tbody>
            </table>
          </div>
        </div>
      </div>

      <div>
        <div class="card">
          <h3>Quick Summary</h3>
          <div class="kv"><b>Total Devices</b><div id="summaryDevices">â€”</div></div>
          <div class="kv"><b>Records</b><div id="summaryRows">â€”</div></div>
          <div class="kv"><b>Latest Speed</b><div id="summarySpeed">â€”</div></div>
        </div>

        <div class="card">
          <h3>Status</h3>
          <div class="kv"><b>API</b><div id="apiStatus">â€”</div></div>
          <div class="kv"><b>Last fetched</b><div id="lastFetched">â€”</div></div>
        </div>
      </div>
    </div>
  </div>

<script>
const API_URL = "https://k4w2chg414.execute-api.ap-south-1.amazonaws.com/default/myproducts-api";

const deviceSelect = document.getElementById('deviceSelect');
const refreshNow = document.getElementById('refreshNow');
const refreshIntervalSelect = document.getElementById('refreshInterval');

const statusBadge = document.getElementById('statusBadge');
const apiStatus = document.getElementById('apiStatus');
const lastFetched = document.getElementById('lastFetched');
const rowsCount = document.getElementById('rowsCount');

const latest_id = document.getElementById('latest_id');
const latest_person = document.getElementById('latest_person');
const latest_location = document.getElementById('latest_location');
const latest_gps = document.getElementById('latest_gps');
const latest_speed = document.getElementById('latest_speed');
const latest_temp = document.getElementById('latest_temp');
const latest_status = document.getElementById('latest_status');
const latest_ts = document.getElementById('latest_ts');

const summaryDevices = document.getElementById('summaryDevices');
const summaryRows = document.getElementById('summaryRows');
const summarySpeed = document.getElementById('summarySpeed');

const historyBody = document.getElementById('historyBody');

let refreshMs = Number(refreshIntervalSelect.value);
let pollTimer = null;
let lastData = [];

refreshNow.addEventListener('click', () => fetchAndRender(true));
refreshIntervalSelect.addEventListener('change', () => {
  refreshMs = Number(refreshIntervalSelect.value);
  restartPoll();
});
deviceSelect.addEventListener('change', () => renderFromCache());

function safeGet(obj, keys){
  for(const k of keys) if(obj[k] !== undefined) return obj[k];
  return undefined;
}
function fmtDate(ts){
  if(!ts) return "--";
  const d = new Date(ts);
  return d.toLocaleString();
}
function escapeHTML(s){
  return String(s||'').replace(/[&<>"'`]/g, c => ({
    '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;','`':'&#x60;'
  }[c]));
}

async function fetchAndRender(){
  statusBadge.innerText = 'Loadingâ€¦';
  statusBadge.className = 'badge tiny';

  try{
    const res = await fetch(API_URL);
    lastFetched.innerText = new Date().toLocaleString();
    apiStatus.innerText = `${res.status} ${res.statusText}`;

    const payload = await res.json();
    let items = Array.isArray(payload) ? payload :
                Array.isArray(payload.Items) ? payload.Items :
                [];

    items.forEach(it => {
      if(!it.timestamp && (it.ts || it.time)) it.timestamp = it.ts || it.time;
    });

    items.sort((a,b)=> new Date(a.timestamp||0) - new Date(b.timestamp||0));

    lastData = items;

    rowsCount.innerText = items.length;
    summaryRows.innerText = items.length;

    const uniqueDevices = [...new Set(items.map(i => i.id || i.device_id))];
    summaryDevices.innerText = uniqueDevices.length;

    populateDeviceSelect(uniqueDevices);

    renderFromCache();

    statusBadge.innerText = 'OK';
    statusBadge.className = 'badge tiny ok';

  }catch{
    statusBadge.innerText = 'Fetch error';
    statusBadge.className = 'badge tiny err';
    apiStatus.innerText = 'Error';
  }
}

function populateDeviceSelect(ids){
  const prev = deviceSelect.value;
  deviceSelect.innerHTML = `<option value="__all">All devices (live)</option>`;
  ids.forEach(id => {
    const opt = document.createElement('option');
    opt.value = id;
    opt.innerText = id;
    deviceSelect.appendChild(opt);
  });
  if(prev && [...deviceSelect.options].some(o=>o.value===prev)) deviceSelect.value = prev;
}

function renderFromCache(){
  const sel = deviceSelect.value;

  if(sel === '__all'){
    const latest = lastData[lastData.length-1];
    latest ? updateLatestCard(latest) : clearLatestCard();
    renderHistoryTable(lastData.slice().reverse());
  } else {
    const filtered = lastData.filter(r => r.id == sel || r.device_id == sel);
    if(filtered.length){
      updateLatestCard(filtered[filtered.length-1]);
      renderHistoryTable(filtered.slice().reverse());
    } else {
      clearLatestCard();
      renderHistoryTable([]);
    }
  }
}

function updateLatestCard(row){
  latest_id.innerText = row.id || row.device_id || "--";
  latest_person.innerText = safeGet(row, ["person","Person Name","PersonName"]) || "--";
  latest_location.innerText = row.location || "--";
  latest_gps.innerText = row.gps || "--";
  latest_speed.innerText = row.speed ?? "--";
  latest_temp.innerText = row.engine_temp ?? "--";
  latest_status.innerText = row.status || "--";
  latest_ts.innerText = fmtDate(row.timestamp);
  summarySpeed.innerText = row.speed ? row.speed + " km/h" : "â€”";
}
function clearLatestCard(){
  latest_id.innerText = latest_person.innerText = latest_location.innerText =
  latest_gps.innerText = latest_speed.innerText = latest_temp.innerText =
  latest_status.innerText = latest_ts.innerText = summarySpeed.innerText = "--";
}

function renderHistoryTable(rows){
  if(!rows.length){
    historyBody.innerHTML = `<tr><td colspan="8" class="tiny">No records</td></tr>`;
    return;
  }
  historyBody.innerHTML = rows.slice(0,1000).map(r=>`
    <tr>
      <td>${escapeHTML(r.id||r.device_id)}</td>
      <td>${escapeHTML(safeGet(r,["Person Name","PersonName","person"]))}</td>
      <td>${escapeHTML(r.location)}</td>
      <td>${escapeHTML(r.speed)}</td>
      <td>${escapeHTML(r.engine_temp)}</td>
      <td>${escapeHTML(r.status)}</td>
      <td>${escapeHTML(r.gps)}</td>
      <td>${escapeHTML(fmtDate(r.timestamp))}</td>
    </tr>
  `).join('');
}

function restartPoll(){
  if(pollTimer) clearInterval(pollTimer);
  pollTimer = setInterval(fetchAndRender, refreshMs);
  fetchAndRender();
}

restartPoll();
</script>
</body>
</html>
